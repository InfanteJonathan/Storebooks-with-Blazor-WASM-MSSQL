@inject LibroService _service
@inject VentasService _serviceL
@inject UsuarioServicio _serviceU
@inject AuthenticationStateProvider _authenticationStateProvider

<h1>Últimos Libros Agregados</h1>



@* <button @onclick="ShowToast">Show Toast</button> *@

@if (toastMessage != null)
{
    <Toast Message="@toastMessage" Show="@showToast" Exito="@Exito"></Toast>
}

@if (libros == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="image-container">
        @foreach (var item in libros)
        {
            <div>
                <div class="image-item">
                    <img @onclick='() => _navigate.NavigateTo($"/detalle/{item.IdLibro}")' style="cursor:default;" src="@item.Imagen" alt="Imagen" />
                </div>
                <div>Titulo: @item.Titulo</div>
                <div>Precio: @item.Precio</div>
                <div>
                    <button class="btn btn-primary" @onclick="() => Agregar(item.IdLibro)"><i class="bi bi-cart3"></i> Agregar</button>
                </div>
            </div>
        }
    </div>    
}

@if(usuarios != null)
{
    <div class="">
        @foreach (var item in usuarios)
        {
            <div>
                <div>Nombre: @item.Name</div>
                <div>Email: @item.Email</div>
                <div>Contraseña: @item.Password</div>
            </div>
        }
    </div>
}

@code {
    List<LibroViewModel>  libros = new List<LibroViewModel>();
    private string toastMessage = string.Empty;
    private bool showToast = false;
    bool Exito = false;
    List<UserViewModel> usuarios = new();



    protected override async Task OnInitializedAsync()
    {
        await CargarLibro();
        await getUserId();
        await LlamarUsers();
    }

    async Task CargarLibro()
    {
        libros = await _service.ListaLibros();
    }

    async Task LlamarUsers()
    {
        var response = await _serviceU.ObtenerUsuariosAsync();

        if(response != null)
        {
            usuarios = response;
        }
        else
        {
            
        }
    }

    async Task<string> getUserId()
    {

        var UserId = await _serviceU.ObtenerUsuarioActualAsync();
        return UserId;
    }

    async Task Agregar(int id)
    {
        var buscarLibro = await _service.obtenerLibro(id);
        var userId = await getUserId();

        if (string.IsNullOrEmpty(userId))
        {
            toastMessage = "Debe Registrarse y/o Iniciar Sesión para poder agregar productos";           
            ShowToast();
        }
        else
        {
            var response = await _serviceL.CrearDetalleVenta(buscarLibro, userId);
            Exito = response.Exito;
            toastMessage = response.Mensaje;
            ShowToast();
        }

        

      
    }

    private void ShowToast()
    {
        showToast = true;
        // Ocultar el toast después de 3 segundos
        Task.Delay(3000).ContinueWith(_ =>
        {
            InvokeAsync(() => showToast = false);
        });
    }
}
